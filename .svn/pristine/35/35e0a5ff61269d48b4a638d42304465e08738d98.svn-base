package com.taiji.zxfy.zxsq.webwork.action;

import java.io.File;
import java.io.IOException;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Random;
import java.util.Set;

import javax.servlet.http.HttpServletResponse;

import org.junit.Test;


import com.opensymphony.webwork.ServletActionContext;
import com.taiji.core.webwork.action.ProtectedDetailAction;
import com.taiji.zxfy.zxsq.domain.AppModel;
import com.taiji.zxfy.zxsq.domain.ArchiveModel;
import com.taiji.zxfy.zxsq.domain.InfoModel;
import com.taiji.zxfy.zxsq.service.IZxsqService;
import com.taiji.zxfy.zxsq.service.impl.ZxsqServiceImpl;
import com.taiji.zxfy.zxsq.utils.HttpSend;

public class ZxsqDetailAction extends ProtectedDetailAction{

	private static final long serialVersionUID = 1L;
	private InfoModel infoModel;
	private AppModel app;
	private String infoId;
	private IZxsqService zxsqService;
	private ArchiveModel archive;
	private File[] caiLiao;
	private String[] caiLiaoFileName;
	private String sqrID;
	private String clID;
	private String clType;
	private String[] xzbzwClName;
	private String[] dbrArr;
	private String fyjg;
	private String uploadUserId;
	private String tuJing;
	private String otherValue;
	private String clName;
	private String clNum;
	private String actionName = "";

	
	public boolean checkSq(String infoId, int jinDu)
	{ // 判断案件
		List<InfoModel> infoList = coreService.find("from InfoModel t where ID = ?", (Object)infoId);
		if(infoList == null || infoList.isEmpty() || infoList.size() != 1)
		{ // 先根据id 判断id是否存在
			return false;
		}
		infoModel = infoList.get(0);
		if(!"13".equals(infoModel.getStatus()))
		{ // 判断案件状态
			return false;
		}
		if(jinDu <= Integer.parseInt(infoModel.getJinDu()))
		{// 判断案件进度
			return true;
		}
		
		return false;
	}
	
//	private InfoModel updateJinDu(String id, String jinDu)
//	{ // 修改  进度
//		this.infoModel = zxsqService.findInfoModel(id);
//		infoModel.setJinDu(jinDu);
//		coreService.update(infoModel);
//		
//		this.infoModel = zxsqService.findInfoModel(id);
//		
//		return infoModel;
//	}
	
	
	
	public String newsq()
	{// 新的申请, 创建案件
		Date date = new Date();
		infoModel = new InfoModel();
		String currentTime = new SimpleDateFormat("yyyyMMddHHmmssSSS").format(date);
		Random random = new Random();
		infoId = currentTime + random.nextInt(1000);
		// 新建案件, 设置默认值
		infoModel.setId(infoId);
		currentTime = new SimpleDateFormat("yyyy-MM-dd").format(date);
		infoModel.setReceiveDate(currentTime); // 申请时间
		infoModel.setReceiveRealDate(currentTime); // 录入时间
		// 是否涉及安全    字段没有, xzfy 可以添加
		infoModel.setAppType("1"); // 申请人类别(1：公民 2：法人)  默认 公民申请
		infoModel.setBreakRight("北京市人民政府"); // 暂定
		infoModel.setXzfyOrg("省部级行政复议机关"); // 暂定
		infoModel.setStatus("13"); // 案件状态   (填写中)
		infoModel.setCheckStatus("0"); // 审批状态
		infoModel.setCaseNum(new SimpleDateFormat("yyMMddHHmmssSSS").format(date) + new Random().nextInt(1000)); // 案件申请码
		infoModel.setCaseOrg(fyjg); // 案件受理单位
		infoModel.setReceiveType("4"); // 设置案件申请方式        4:在线
		infoModel.setIsBuZheng("0"); // 是否补正
		infoModel.setJinDu("0"); // 在线申请进度
		infoModel.setFlag("0");//同步意见证据标识
		coreService.save(infoModel); // 新建案件
		this.actionName = "gotoGmSave";
		this.infoId = infoModel.getId();
		
		return SUCCESS;
	}
	
	public String gotoGmSave()
	{ // 切换为 公民申请
		if(!this.checkSq(infoId, 0))
		{
			return ERROR;
		}
		infoId = this.getInfoId();
		zxsqService.gotoGmSave(infoId);
		
		this.actionName = "sqrList";
		return SUCCESS;
	}
	
	public String gotoFrSave()
	{ // 切换为 法人申请
		if(!this.checkSq(infoId, 0))
		{
			return ERROR;
		}
		infoId = this.getInfoId();
		zxsqService.gotoFrSave(infoId);

		this.actionName = "sqrList";
		return SUCCESS;
	}
	
	public String runSqrSave()
	{ // 保存 申请人信息
		if(!this.checkSq(infoId, 0))
		{
			return ERROR;
		}
		InfoModel infoModel = zxsqService.findInfoModel(infoId);
		infoModel.setJinDu("0");
		coreService.update(infoModel);
		coreService.evict(infoModel);
		app = this.getApp();
		String str = zxsqService.saveSqr(infoId, app , caiLiao, caiLiaoFileName);
		this.actionName = "sqrList";
		return SUCCESS;
	}
	
	public String runSqrUpdate()
	{
		app = this.getApp();
		app.setId(Integer.parseInt(sqrID));
		String str = zxsqService.updateSqr(app);
		this.actionName = "sqrList";
		return str;
	}
	
	
	public String runSqrDel()
	{// 删除申请人
		app = this.getApp();
		// ... 删除申请人 时   应该删除相关资料
		zxsqService.deleteSqr(infoId, app.getId());
		coreService.remove(app);
		
		this.actionName = "sqrList";
		return SUCCESS;
	}
	
	
	
	
	// 添加代表人
	public String runSqrDbrSave()
	{
		if(dbrArr.length > 5)
		{
			return ERROR;
		}
		zxsqService.saveDbr(infoId, dbrArr);
		
		this.actionName = "dlrSave";
		return SUCCESS;
	}
	
	
	
	// 添加 代理人
	public String runDlrSave()
	{
		app = this.getApp();

		// 给 info 表赋默认值    // 可以把 这段放到service中
		infoId = this.getInfoId();
		infoModel = zxsqService.findInfoModel(infoId);
		Set<AppModel> appS = infoModel.getAppModels();
		Iterator<AppModel> it = appS.iterator();
		AppModel a = new AppModel();
		for(;it.hasNext();)
		{
			a = it.next();
			if("0".equals(a.getProxyType()))
			{
				it.remove();
			}
		}
		infoModel.setRenCount(appS.size() + "");
		String appDetail = "";
		String appShow = "";
		
		
		it = appS.iterator();
		for(;it.hasNext();)
		{
			a = it.next();
			if("1".equals(a.getSexy()))
			{
				appDetail += a.getAppName() + "，男，";
			}
			else
			{
				appDetail += a.getAppName() + "，女，";
			}
			
//				申请人0，男，身份证号36042819999999999，送达地址送达地址0，邮编000000，电话5398077；申请人1，男，身份证号360428198888888888，送达地址送达地址1，邮编11111111，电话5391077；
			
			appDetail += "身份证号" + a.getAppId() + "，送达地址" + a.getMailAddress();
			//+ "，邮编" + app.getPostCode() + "，电话" + app.getTelephone() + "；";
			if(a.getPostCode() != null && "".equals(a.getPostCode()))
			{
				appDetail += "，邮编" + a.getPostCode();
			}
			appDetail += "，电话" + a.getTelephone() + "；";
			
			
			appShow += a.getAppName() + ",";
			
		}
		
		appShow = appShow.substring(0, appShow.length()-1);
		
		if("1".equals(infoModel.getAppType()))
		{
			infoModel.setAppDetail(appDetail);
		}
		infoModel.setAppShow(appShow);
		
		coreService.update(infoModel);
		
		if(app != null && app.getAppName() != null && !"".equals(app.getAppName()) && app.getTelephone() != null && !"".equals(app.getTelephone()))
		{
			zxsqService.saveDlr(infoId, app);
		}
		else
		{
			zxsqService.deleteDlr(infoId);
		}
		
		this.actionName = "zylxrSave";
		return SUCCESS;
	}
	
	
	
	
	public String runZylxrSave()
	{ // 添加 主要联系人
		app = this.getApp();
		infoId = this.getInfoId();
		otherValue = this.getOtherValue(); // 暂时用来  存储一次  网页传过来的 案件申请码
		// 
		if(app == null || app.getId() == null || "".equals(app.getId()) )
		{
			return ERROR;
		}
		
		zxsqService.saveZylxr(infoId, app.getId());
		
		infoModel = zxsqService.findInfoModel(infoId);
		if(infoModel.equals(otherValue))
		{
			return SUCCESS;
		}
		
		return ERROR;
	}
	
	public void sendSqm()
	{
		app = this.getApp();
		infoId = this.getInfoId();
		String json = ERROR;
		if(app == null || app.getId() == null || "".equals(app.getId()) )
		{
			json = ERROR;
		}else{
			zxsqService.saveZylxr(infoId, app.getId());
			String sqm = zxsqService.findInfoModel(infoId).getCaseNum();
			System.out.println(">>>..." + sqm);
			app = zxsqService.findAppModel(app.getId());
			// ... 这里发送申请码
			
			try
			{
				String strSmsUrl = "http://www.stongnet.com/sdkhttp/sendsms.aspx";
				
				
				String strReg = ""; // 账号
				String strPwd = ""; // 密码
				String strSourceAdd = "";
				String strPhone = app.getTelephone(); // 手机号码，多个手机号用半角逗号分开，最多1000个
				String strContent = HttpSend.paraTo16("您好，您的申请代码是" + sqm + "，请您于3日内完成案件信息填写。逾期系统将不再保留，如您想申请行政复议，需要重新填写。");
				
				String strSmsParam = "reg=" + strReg + "&pwd=" + strPwd + "&sourceadd=" + strSourceAdd + "&phone=" + strPhone + "&content=" + strContent;
				String strRes = HttpSend.postSend(strSmsUrl, strSmsParam);
				
				System.out.println("短信接口 返回的值..." + strRes);
				
				if (strRes.contains("result=0")) {
					json = SUCCESS;
				} else {
					json = ERROR;
				}
			}
			catch(Exception e)
			{
				json = ERROR;
				e.printStackTrace();
			}
		}
		
		HttpServletResponse response = ServletActionContext.getResponse();
		response.setCharacterEncoding("utf-8");
		try {
			PrintWriter out = response.getWriter();
			out.print(json);
			out.flush(); 
			out.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	
	public void checkSqm()
	{ // 异步校验 案件申请码
		String json = "error";
		infoModel = zxsqService.findInfoModel(infoId);
		if(infoModel.getCaseNum().equals(otherValue))
		{
			json = "success";
		}
		System.out.println(infoModel.getCaseNum());
		HttpServletResponse response = ServletActionContext.getResponse();
		response.setCharacterEncoding("utf-8");
		try {
			PrintWriter out = response.getWriter();
			out.print(json);
			out.flush();
			out.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	
	
	
	
	public String runBsqrSave()
	{ // 保存   被申请人
		infoModel = this.getInfoModel();
		
		
		zxsqService.saveBsqr(infoId, infoModel);
		
		this.actionName = "isNotXzzwSave";
		return SUCCESS;
	}
	
	
	public String runIsNotXzzwSave()
	{ //  是否作为
		infoModel = this.getInfoModel();
		
		zxsqService.saveIsNotZw(infoId, infoModel);
		
		if("0".equals(infoModel.getIsManage()))
		{
			this.actionName = "xzzwSave";
		}
		else if("2".equals(infoModel.getIsManage()))
		{
			this.actionName = "xzbzwSave";
		}
		else{
			return ERROR;
		}
		return SUCCESS;
	}
	
	
	public String runXzzwSave()
	{ // 如果是作为案件, 保存的作为案件信息
		infoModel = this.getInfoModel();
		String str = infoModel.getXwName() + "（" + infoModel.getXwNum() + "）；知道时间：" + infoModel.getExecuteDate() + "（" + tuJing + "）；";
		infoModel.setRequireFy(str);
		infoModel.setBuzhengFrom(infoModel.getExecuteDate() + "（" + tuJing + "）");
		
		zxsqService.saveXzzw(infoId, infoModel);
		
		this.actionName = "sslySave";
		return SUCCESS;
	}

	
	public String runXzbzwSave()
	{ // 保存不作为案件
		infoModel = this.getInfoModel();
		zxsqService.saveXzbzw(infoId, infoModel);
		
		this.actionName = "sslySave";
		return SUCCESS;
	}
	
	
	public String runSslySave()
	{ // 保存  事实理由
		infoModel = this.getInfoModel();
		if(infoModel.getAppAdviceDetail().length() > 5000)
		{// 超过了字数
			return ERROR;
		}
		zxsqService.saveSsly(infoId, infoModel);
		
		this.actionName = "sqrSfzmSave";
		return SUCCESS;
	}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	public String proceedSq()
	{
		// 先判断  申请码  是否存在
		
		// 判断  案件状态
		
		// 比较   案件时间   判断是否过期
		
		
		// 判断案件申请码是否正确
		
		return ERROR;
	}
	
	
	

	
	
	
	
	
	
	
	
	
	

	

	
	
	
	
	
	
	
	
	public String runUploadSqrSfzmSave()
	{ 
		// ... 暂未支持
		try {
			zxsqService.saveSqrSfzm(clType, infoId, sqrID, caiLiao[0], caiLiaoFileName[0]);
		} catch (IOException e) {
			System.out.println("请重新上传文件...");
		}
		
		this.actionName = "sqrSfzmSave";
		return SUCCESS;
	}
	
	public String runSqrSfzmDelAll()
	{
		InfoModel infoModel = zxsqService.findInfoModel(infoId);
		infoModel.setJinDu("7");
		coreService.update(infoModel);
		coreService.evict(infoModel);
		
		sqrID = this.sqrID;
		zxsqService.deleteSqrSfzmAll(sqrID);
		
		this.actionName = "sqrSfzmSave";
		return SUCCESS;
	}
	
	public String runSqrSfzmDel()
	{
		InfoModel infoModel = zxsqService.findInfoModel(infoId);
		infoModel.setJinDu("7");
		coreService.update(infoModel);
		coreService.evict(infoModel);
		
		sqrID = this.sqrID;
		clID = this.clID;
		zxsqService.deleteSqrSfzm(sqrID, clID);
		
		this.actionName = "sqrSfzmSave";
		return SUCCESS;
	}
	
	
	
	
	// 保存 申请人身份证明
	public String runSqrSfzmSave()
	{
//		try {
//			zxsqService.saveSqrSfzm(clType, infoId, sqrID, caiLiao, caiLiaoFileName);
//		} catch (IOException e) {
//			System.out.println("请重新上传文件...");
//		}
		
		if(zxsqService.isNotDlr(infoId))
		{
			this.actionName = "dlsxSave";
		}else if(zxsqService.isNotXzzw(infoId))
		{
			this.actionName = "xzzwClSave";
		}else
		{
			this.actionName = "xzbzwClSave";
		}
		
		return SUCCESS;
	}
	
	public String sqrSfzmNext()
	{
		if(zxsqService.isNotDlr(infoId))
		{
			this.actionName = "dlsxSave";
		}else if(zxsqService.isNotXzzw(infoId))
		{
			this.actionName = "xzzwClSave";
		}else
		{
			this.actionName = "xzbzwClSave";
		}
		
		return SUCCESS;
	}
	
	public String runDlsxSave()
	{
		
		try {
			zxsqService.saveDlsx(clType, infoId, caiLiao[0], caiLiaoFileName[0]);
		} catch (IOException e) {
			System.out.println("请重新上传文件...");
		}
		
		this.actionName = "dlsxSave";
		return SUCCESS;
	}
	
	public String runDlsxDel()
	{
		clID = this.getClID();
		zxsqService.deleteFile(clID);
		
		this.actionName = "dlsxSave";
		return SUCCESS;
	}
	
	// 保存  代理手续证明材料
	public String runDlsxNext()
	{
		// 保存代理手续材料
		
		
		
		if(zxsqService.isNotXzzw(infoId))
		{
			this.actionName = "xzzwClSave";
		}else
		{
			this.actionName = "xzbzwClSave";
		}
		
		return SUCCESS;
	}
	
	//  添加   作为案件材料
	public String runXzzwClSave()
	{
		// ++
		try {
			zxsqService.saveXzzwCl(infoId, clName, clNum, caiLiao[0], caiLiaoFileName[0]);
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("文件上传失败, 请重新上传...");
		}
		
		this.actionName = "otherSave";
		return SUCCESS;
	}
	
	public String runUploadXzzwClSave()
	{
		try {
			zxsqService.saveXzzwCl(infoId, clName, clNum, caiLiao[0], caiLiaoFileName[0]);
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("文件上传失败, 请重新上传...");
		}
		
		this.actionName = "xzzwClSave";
		return SUCCESS;
	}
	
	public String runXzzwClDel()
	{
		clID = this.getClID();
		
		
		
		zxsqService.deleteFile(clID);
		
		this.actionName = "xzzwClSave";
		return SUCCESS;
	}
	
	public String runXzbzwClSave()
	{
		// ++
		try {
			zxsqService.saveXzbzwCl(infoId, xzbzwClName[0], clType, caiLiao[0], caiLiaoFileName[0]);
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("文件上传失败, 请重新上传...");
		}
		
		this.actionName = "xzbzwClSave";
		return SUCCESS;
	}
	
	public String xzbzwClAllDel()
	{
		zxsqService.deleteXzbzwClAll(infoId, clType);
		
		this.actionName = "xzbzwClSave";
		return SUCCESS;
	}
	
	public String runOtherSave()
	{
		try {
			zxsqService.saveOther(infoId, clName, clNum, caiLiao[0], caiLiaoFileName[0]);
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("文件上传失败, 请重新上传...");
		}
		
		this.actionName = "otherSave";
		return SUCCESS;
	}
	
	public String runQtclDel()
	{
		clID = this.getClID();
		zxsqService.deleteFile(clID);
		
		this.actionName = "otherSave";
		return SUCCESS;
	}
	
	public String tiJiaoShenQing()
	{
		infoId = this.getInfoId();
		infoModel = zxsqService.findInfoModel(infoId);
		infoModel.setStatus("0");
		
		infoModel.setBuzhengTo(new SimpleDateFormat("yyyy-MM-dd").format(new Date()));
		
		coreService.update(infoModel);
		
		zxsqService.createPdf(infoId);
		
		this.actionName = "ajView";
		return SUCCESS;
	}
	
	
	
	
	
	
	public InfoModel getInfoModel() {
		return infoModel;
	}

	public void setInfoModel(InfoModel infoModel) {
		this.infoModel = infoModel;
	}

	public AppModel getApp() {
		return app;
	}

	public void setApp(AppModel app) {
		this.app = app;
	}

	public String getInfoId() {
		return infoId;
	}

	public void setInfoId(String infoId) {
		this.infoId = infoId;
	}

	public static long getSerialversionuid() {
		return serialVersionUID;
	}
	
	public ArchiveModel getArchive() {
		return archive;
	}

	public void setArchive(ArchiveModel archive) {
		this.archive = archive;
	}

	public File[] getCaiLiao() {
		return caiLiao;
	}

	public void setCaiLiao(File[] caiLiao) {
		this.caiLiao = caiLiao;
	}

	public String[] getCaiLiaoFileName() {
		return caiLiaoFileName;
	}

	public void setCaiLiaoFileName(String[] caiLiaoFileName) {
		this.caiLiaoFileName = caiLiaoFileName;
	}

	public String getSqrID() {
		return sqrID;
	}

	public void setSqrID(String sqrID) {
		this.sqrID = sqrID;
	}
	
	public String getClType() {
		return clType;
	}

	public void setClType(String clType) {
		this.clType = clType;
	}

	public String[] getXzbzwClName() {
		return xzbzwClName;
	}

	public void setXzbzwClName(String[] xzbzwClName) {
		this.xzbzwClName = xzbzwClName;
	}

	public String[] getDbrArr() {
		return dbrArr;
	}

	public void setDbrArr(String[] dbrArr) {
		this.dbrArr = dbrArr;
	}

	public String getFyjg() {
		return fyjg;
	}

	public void setFyjg(String fyjg) {
		this.fyjg = fyjg;
	}

	public String getUploadUserId() {
		return uploadUserId;
	}

	public void setUploadUserId(String uploadUserId) {
		this.uploadUserId = uploadUserId;
	}

	public String getTuJing() {
		return tuJing;
	}

	public void setTuJing(String tuJing) {
		this.tuJing = tuJing;
	}

	public String getOtherValue() {
		return otherValue;
	}

	public void setOtherValue(String otherValue) {
		this.otherValue = otherValue;
	}

	public String getClID() {
		return clID;
	}

	public void setClID(String clID) {
		this.clID = clID;
	}

	@Override
	public Class getPersistentClass() {
		return AppModel.class;
	}

	public IZxsqService getZxsqService() {
		return zxsqService;
	}

	public void setZxsqService(IZxsqService zxsqService) {
		this.zxsqService = zxsqService;
	}

	public String getClName() {
		return clName;
	}

	public void setClName(String clName) {
		this.clName = clName;
	}

	public String getClNum() {
		return clNum;
	}

	public void setClNum(String clNum) {
		this.clNum = clNum;
	}


	public String getActionName() {
		return actionName;
	}
	
}